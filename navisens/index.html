<html>
  <head>
    <title>Ukaton Side Missions</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r118/three.min.js"></script>
    <script src="../SideMission.js"></script>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  </head>
  <style>
    body {
      margin: 0;
      padding: 0;
    }
    #container {
      display: grid;
      width: 100%;
      height: 100%;

      grid-template-rows: repeat(2, 1fr);
      grid-template-columns: repeat(2, 1fr);

      grid-template-areas:
        "navisens connection"
        "navisens scene";
    }

    #container > * {
      width: 100%;
      height: 100%;
      box-sizing: border-box;
      border: solid black 1px;
      margin: 0;
      padding: 0;
      position: relative;
    }

    canvas {
      width: 100%;
      height: 100%;
    }
    #connection {
      padding-left: 1em !important;
      grid-area: connection;
    }
    #euler {
      grid-area: euler;
    }
    #scene {
      grid-area: scene;
    }
    #navisens {
      grid-area: navisens;
      background-color: gray;
    }

    #navisens canvas {
      width: 100%;
      height: 100%;
    }
  </style>
  <body>
    <div id="container">
      <div id="connection">
        <h1>
          Ukaton Side Mission
        </h1>

        <button onclick="connect(event)">
          connect
        </button>

        <button onclick="enable()">
          enable
        </button>
        <button onclick="disable()">
          disable
        </button>

        <button onclick="start(event)">
          start
        </button>
      </div>
      <a-scene embedded vr-mode-ui="enabled: false">
        <a-assets>
          <a-asset-item
            id="caseAsset"
            src="https://cdn.glitch.com/6c283599-191e-4c4a-b236-e1e1f0d90e7a%2Fside%20mission.obj?v=1621228628422"
          ></a-asset-item>
          <a-asset-item
            id="lidAsset"
            src="https://cdn.glitch.com/6c283599-191e-4c4a-b236-e1e1f0d90e7a%2Fside%20mission%20lid.obj?v=1621228763857"
          ></a-asset-item>
          <img
            id="logoAsset"
            src="https://cdn.glitch.com/6c283599-191e-4c4a-b236-e1e1f0d90e7a%2Fname_logo.PNG?v=1621230110826"
          />
        </a-assets>
        <a-camera
          active
          look-controls="enabled: false;"
          position="0 3 0"
          rotation="-90 0 0"
        ></a-camera>
        <a-entity id="sideMission" position="0 0 0" rotation="0 -90 0">
          <a-image
            scale="1.8 1.8 1.8"
            rotation="-90 0 0"
            position="0 0.455 0"
            id="logo"
            src="#logoAsset"
          ></a-image>
          <a-entity scale="0.05 0.05 0.05" rotation="-90 -90 0">
            <a-entity position="-20 -17.5 -10">
              <a-entity id="case" obj-model="obj: #caseAsset;"></a-entity>
              <a-entity id="lid" obj-model="obj: #lidAsset;"></a-entity>
            </a-entity>
          </a-entity>
        </a-entity>
        <a-sky color="darkgrey"></a-sky>
      </a-scene>
      <div id="navisens">
        <canvas></canvas>
      </div>
    </div>
  </body>
  <script>
    const sideMission = new SideMission();

    function connect(event) {
      sideMission.connect().then(() => event.target.remove());
    }

    sideMission.addEventListener("connected", event => {
      enable();
    });

    function enable() {
      if (sideMission.isConnected) {
        sideMission.configureImu({
          acceleration: 20,
          linearAcceleration: 20,
          rotationRate: 20,
          quaternion: 80
        });
      }
    }

    function disable() {
      if (sideMission.isConnected) {
        sideMission.configureImu({
          acceleration: 0,
          linearAcceleration: 0,
          rotationRate: 0,
          quaternion: 0
        });
      }
    }

    const sideMissionEntity = document.getElementById("sideMission");
    sideMission.addEventListener("quaternion", event => {
      const { message } = event;
      const { quaternion, timestamp } = message;
      sideMissionEntity.object3D.quaternion.copy(quaternion);
    });

    const navisensCanvas = document.querySelector("#navisens canvas");
    window.addEventListener("resize", event => {
      const { clientWidth, clientHeight } = document.body;
      navisensCanvas.width = clientWidth / 2;
      navisensCanvas.height = clientHeight;
    });
    window.dispatchEvent(new Event("resize"));
  </script>

  <script>
    const samples = {}; // {timestamp: {acceleration, linearAcceleration, rotationRate}}
    const numberOfSamples = 100;
    const eventTypes = ["acceleration", "linearAcceleration", "rotationRate"];
    let latestTimestamp;
    eventTypes.forEach(type => {
      sideMission.addEventListener(type, event => {
        const { message } = event;
        const { timestamp } = message;
        samples[timestamp] = samples[timestamp] || {};
        samples[timestamp][type] = message[type];
        if (eventTypes.every(type => type in samples[timestamp])) {
          const { acceleration, linearAcceleration, rotationRate } = samples[
            timestamp
          ];
          const interval = latestTimestamp ? timestamp - latestTimestamp : 20;
          latestTimestamp = timestamp;
          const deviceMotionEvent = new DeviceMotionEvent("*devicemotion", {
            accelerationIncludingGravity: {
              x: acceleration.x,
              y: -acceleration.z,
              z: -acceleration.y
            },
            acceleration: {
              x: linearAcceleration.x,
              y: -linearAcceleration.z,
              z: -linearAcceleration.y
            },
            rotationRate: {
              alpha: THREE.Math.radToDeg(rotationRate.x), // pitch
              gamma: THREE.Math.radToDeg(rotationRate.y), // heading (clockwise negative)
              beta: THREE.Math.radToDeg(rotationRate.z) // roll (left negative)
            },
            interval
          });

          deviceMotionEvent.initEvent(`*devicemotion`);
          window.dispatchEvent(deviceMotionEvent);
          delete samples[timestamp];
        } else {
          setTimeout(() => {
            delete samples[timestamp];
          }, 1000);
        }
      });
    });

    const camera = document.querySelector("a-camera");
    const scene = document.querySelector("a-scene");
    scene.addEventListener("click", event => {
      camera.object3D.rotation.z =
        sideMissionEntity.object3D.rotation.y + Math.PI / 2;
    });
  </script>

  <script>
    // MONKEY PATCH "devicemotion" EVENT
    const addEventListener = window.addEventListener;
    window.addEventListener = function(type, eventListener, options) {
      switch (type) {
        case "devicemotion":
          return addEventListener.call(
            window,
            `*devicemotion`,
            eventListener,
            options
          );
          break;
        default:
          return addEventListener.apply(window, arguments);
          break;
      }
    };

    // for iOS
    if (window.DeviceMotionEvent.requestPermission) {
      document.onclick = () => DeviceMotionEvent.requestPermission();
    }
  </script>

  <script>
    // NAVISENS MODULE
    var Module = {
      onRuntimeInitialized() {
        this.runtimeInitialized = true;
        window.dispatchEvent(new Event("navisensruntimeinitialized"));
      },
      print(message) {
        console.log(message);
        switch (message) {
          case "INERTIAL ESTIMATOR LOADED!":
            startRenderingPosition();
            this.intertialEstimatorLoaded = true;
            break;
        }
      }
    };

    function receive(x, y, z, timestamp, state) {
      window.dispatchEvent(
        new CustomEvent("navisensreceive", {
          detail: { x, y, z, timestamp, state }
        })
      );
    }

    function reportStatus(statusCode, description) {
      console.log(statusCode, description);
    }

    function start(event) {
      if (Module.runtimeInitialized) {
        event.target.remove();
        Module.start();
      }
    }
  </script>

  <script>
    const positionContainer = document.getElementById("position");
    const canvas = document.querySelector("#navisens canvas");
    const context = canvas.getContext("2d");

    context.strokeStyle = "white";
    context.lineWidth = 10;

    const contextConfiguration = {
      min: {
        x: -2,
        y: -2
      },
      range: {
        x: 8,
        y: 8
      },
      map({ x, y }) {
        return [
          this.clamp((x - this.min.x) / this.range.x) * canvas.width,
          (1 - this.clamp((y - this.min.y) / this.range.y)) * canvas.height
        ];
      },
      clamp(value) {
        return Math.max(0, Math.min(1, value));
      },
      moved: false
    };

    const data = [];
    window.addEventListener("navisensreceive", event => {
      const { x, y } = event.detail;
      data.push({ x, y });
    });

    let renderPositionAnimationFrameRequestId;

    function startRenderingPosition() {
      this.stopRenderingPosition();

      contextConfiguration.moved = false;
      context.clearRect(0, 0, canvas.width, canvas.height);
      context.beginPath();

      renderPositionAnimationFrameRequestId = requestAnimationFrame(
        renderPositionAnimationFrame
      );
    }
    function renderPositionAnimationFrame() {
      renderPosition();
      renderPositionAnimationFrameRequestId = requestAnimationFrame(
        renderPositionAnimationFrame
      );
    }
    function renderPosition() {
      while (data.length) {
        const [x, y] = contextConfiguration.map(data.shift());
        if (!contextConfiguration.moved) {
          context.strokeStyle = "white";
          context.lineWidth = 5;
          context.moveTo(x, y);
          contextConfiguration.moved = true;
        }
        context.lineTo(x, y);
        context.stroke();
      }
    }
    function stopRenderingPosition() {
      if (!isNaN(renderPositionAnimationFrameRequestId)) {
        context.closePath();
        cancelAnimationFrame(renderPositionAnimationFrameRequestId);
        delete renderPositionAnimationFrameRequestId;
      }
    }
  </script>

  <script src="https://core.navisens.com/webcore.js"></script>
</html>
