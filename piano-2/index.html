<html>
  <head>
    <title>Piano WebXR</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://gftruj.github.io/hand.tracking.controls.extras/dist/aframe-hand-tracking-controls-extras.js"></script>
    <script src="/BaseMission.js"></script>
    <script src="/WebSocketMissionDevice.js"></script>
    <script src="/TapStrap.js"></script>
    <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
    <script src="/piano-2/scales.js"></script>
    <script src="/piano-2/instruments/index.js" type="module"></script>
    <script src="/piano-2/piano-component.js" defer></script>
  </head>

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
    }
    #overlay {
      position: absolute;
      z-index: 1;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    #overlay .clickable {
      pointer-events: all;
    }
    #overlay .hidden {
      display: none;
    }
  </style>

  <body>
    <div id="overlay">
      <button class="clickable connect missionDevice">
        connect via WebSockets
      </button>
      <button disabled class="clickable connect tapStrap left">
        left tap strap
      </button>
      <button disabled class="clickable connect tapStrap right">
        right tap strap
      </button>
    </div>

    <a-scene>
      <a-entity
        visible="false"
        id="leftHandControls"
        hand-tracking-controls="hand: left;"
        hand-tracking-extras
      ></a-entity>
      <a-entity
        visible="true"
        id="rightHandControls"
        hand-tracking-controls="hand: right;"
        hand-tracking-extras
      >
      </a-entity>

      <a-sky color="grey"></a-sky>

      <a-entity
        id="piano"
        position="0 1.4 -0.3"
        piano="side: right; leftHand: #leftHandControls; rightHand: #rightHandControls; modeText: #modeText; scaleText: #scaleText; camera: #camera; sustainText: #sustainText"
      >
        <template id="fingerIndexTemplate">
          <a-entity
            position="0 0 0"
            rotation="-90 0 0"
            scale="0.1 0.1 0.1"
            visible="false"
          >
            <a-text
              value=""
              color="black"
              material="shader: flat;"
              position="0 0 0"
              align="center"
            ></a-text>
            <a-entity scale="3 1 1">
              <a-plane
                height="0.3"
                opacity="1"
                width="0.08"
                color="white"
                material="shader: flat;"
                position="0 0 -0.001"
              ></a-plane>
            </a-entity>
          </a-entity>
        </template>
        <a-entity position="0 0.1 0" scale="0.1 0.1 0.1">
          <a-text
            id="scaleText"
            value="C"
            color="black"
            material="shader: flat;"
            position="0 0 0"
            align="center"
          ></a-text>
          <a-entity scale="3 1 1">
            <a-plane
              height="0.3"
              opacity="0.7"
              width="0.5"
              color="white"
              material="shader: flat;"
              position="0 0 -0.001"
            ></a-plane>
          </a-entity>
        </a-entity>

        <a-entity position="0.3 0.1 0" scale="0.1 0.1 0.1" visible="false">
          <a-text
            id="sustainText"
            value="sustain"
            color="black"
            material="shader: flat;"
            position="0 0 0"
            align="center"
          ></a-text>
          <a-entity scale="3 1 1">
            <a-plane
              height="0.3"
              opacity="0.7"
              width="0.3"
              color="white"
              material="shader: flat;"
              position="0 0 -0.001"
            ></a-plane>
          </a-entity>
        </a-entity>

        <template id="whiteKeyTemplate">
          <a-entity
            class="key white"
            animation__rotateDown="property: rotation.x; to: 3; startEvents: down; dur: 100"
            animation__rotateUp="property: rotation.x; to: 0; startEvents: up; dur: 100"
          >
            <a-box color="white"></a-box>
          </a-entity>
        </template>
        <template id="blackKeyTemplate">
          <a-entity
            class="key black"
            animation__rotateDown="property: rotation.x; to: 4; startEvents: down; dur: 100"
            animation__rotateUp="property: rotation.x; to: 0; startEvents: up; dur: 100"
          >
            <a-box color="black"></a-box>
          </a-entity>
        </template>
        <a-entity class="keys"></a-entity>
      </a-entity>

      <a-entity position="-0.5 1 -1" scale="0.2 0.2 0.2" visible="false">
        <a-text
          id="modeText"
          value=""
          color="black"
          material="shader: flat;"
          position="0 0 0"
          align="left"
        ></a-text>
        <a-entity scale="3 1 1">
          <a-plane
            height="0.3"
            opacity="0.7"
            width="0.3"
            color="white"
            material="shader: flat;"
            position="0.15 0 -0.001"
          ></a-plane>
        </a-entity>
      </a-entity>
    </a-scene>
  </body>

  <script>
    const missionDevice = new WebSocketMissionDevice();

    const connectMissionDeviceButton = document.querySelector(
      ".connect.missionDevice"
    );
    connectMissionDeviceButton.addEventListener("click", (event) => {
      missionDevice.connect("192.168.1.30");
    });
    missionDevice.addEventListener("connected", () => {
      connectMissionDeviceButton.disabled = true;
      for (const side in connectTapStrapButtons) {
        connectTapStrapButtons[side].disabled = false;
      }
    });
    missionDevice.addEventListener("disconnected", () => {
      connectMissionDeviceButton.disabled = false;
      for (const side in connectTapStrapButtons) {
        connectTapStrapButtons[side].disabled = true;
      }
    });

    const tapStraps = {
      left: new TapStrap(),
      right: new TapStrap(),
    };

    const _tapStrapServices = {
      data: {
        tapData: {
          properties: ["subscribe"],
          onValue: (event, side) => {
            const { value } = event.message;
            tapStraps[side]._onTapData(value);
          },
        },
      },
      support: { tapMode: {} },
    };
    const tapStrapServices = [];
    for (const serviceName in _tapStrapServices) {
      const serviceInfo = {
        name: serviceName,
        uuid: TapStrap.services[serviceName].uuid,
        characteristics: [],
      };
      for (const characteristicName in _tapStrapServices[serviceName]) {
        const { properties, onValue } =
          _tapStrapServices[serviceName][characteristicName];
        const characteristicInfo = {
          name: characteristicName,
          uuid: TapStrap.services[serviceName].characteristics[
            characteristicName
          ].uuid,
        };
        if (onValue) {
          characteristicInfo.onValue = (event) => {
            event.target.tapStrap._onTapData(event.message.value);
          };
        }
        properties?.forEach(
          (property) => (characteristicInfo[property] = true)
        );
        serviceInfo.characteristics.push(characteristicInfo);
      }
      tapStrapServices.push(serviceInfo);
    }

    const tapStrapNames = {
      left: "Tap_D124264",
      right: "Tap_D065264",
    };
    const sides = Object.keys(tapStraps);
    const connectTapStrapButtons = {};
    sides.forEach((side, index) => {
      const tapStrap = tapStraps[side];
      const name = tapStrapNames[side];
      const bleGenericPeer = missionDevice._bleGenericPeers[index];
      bleGenericPeer.tapStrap = tapStrap;
      tapStrap.addEventListener("tapdata", (event) => {
        // FILL - use for playing piano...
        console.log("tap data", side, event);
      });

      const connectButton = document.querySelector(`.connect.tapStrap.${side}`);
      connectButton.addEventListener("click", async (event) => {
        await bleGenericPeer.requestDevice({
          name,
          services: tapStrapServices,
        });
        bleGenericPeer.writeCharacteristic(
          "tapMode",
          TapStrap.InputModes.controller
        );
        intervalId = setInterval(() => {
          bleGenericPeer.writeCharacteristic(
            "tapMode",
            TapStrap.InputModes.controller
          );
        }, 1000 * 10);
      });

      let intervalId;
      bleGenericPeer.addEventListener("isConnected", (event) => {
        connectButton.disabled = bleGenericPeer.isConnected;
        if (bleGenericPeer.isConnected) {
        } else {
          clearInterval(intervalId);
        }
      });
      connectTapStrapButtons[side] = connectButton;
    });
  </script>

  <script>
    const audioContext = Tone.context.rawContext._nativeAudioContext;
    audioContext.addEventListener("statechange", () => {
      console.log("audioContext state:", audioContext.state);
      if (audioContext.state !== "running") {
        document.addEventListener("click", () => audioContext.resume(), {
          once: true,
        });
      }
    });
    audioContext.dispatchEvent(new Event("statechange"));
  </script>
</html>
