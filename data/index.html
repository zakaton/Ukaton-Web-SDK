<html>
  <head>
    <title>Ukaton Side Mission</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r118/three.min.js"></script>
    <script src="./SideMission.js"></script>
  </head>
  <style>
    label {
      display: block;
    }
  </style>
  <body>
    <h1>
      Ukaton Side Mission
    </h1>

    <button onclick="connect(event)">
      connect
    </button>

    <br /><br />

    <div class="name">
      <label
        ><b>Name</b>
        <input type="text" maxlength="30" />
        <button onclick="setName(event)">
          change name
        </button>
      </label>
    </div>

    <br /><br />

    <div class="calibration">
      <b>Calibration</b>
      <label data-calibration="system"> system: <span></span> </label>
      <label data-calibration="gyroscope"> gyroscope: <span></span> </label>
      <label data-calibration="accelerometer">
        accelerometer: <span></span>
      </label>
      <label data-calibration="magnetometer"> magnetometer: <span></span> </label>
      <label data-calibration="fully"> fully calibrated: <span></span> </label>
    </div>

    <br /><br />
    
    <div class="batteryLevel">
      <b>Battery Level</b>: <span>0</span>
    </div>
    
    <br><br>

    <div data-type="acceleration">
      <b>
        Acceleration
      </b>

      <label class="rate">
        rate: <input value="0" type="number" oninput="setRate(event)" min="0" max="65535" step="20" />
      </label>

      <label class="x"> x: <input readonly /> </label>
      <label class="y"> y: <input readonly /> </label>
      <label class="z"> z: <input readonly /> </label>
      <label class="timestamp"> timestamp: <input readonly /> </label>
      <label class="interval"> interval: <input readonly /> </label>
    </div>
    <br />

    <div data-type="gravity">
      <b>
        Gravity
      </b>

      <label class="rate">
        rate: <input value="0" type="number" oninput="setRate(event)" min="0" max="65535" step="20" />
      </label>

      <label class="x"> x: <input readonly /> </label>
      <label class="y"> y: <input readonly /> </label>
      <label class="z"> z: <input readonly /> </label>
      <label class="timestamp"> timestamp: <input readonly /> </label>
      <label class="interval"> interval: <input readonly /> </label>
    </div>
    <br />

    <div data-type="linearAcceleration">
      <b>
        Linear Acceleration
      </b>

      <label class="rate">
        rate: <input value="0" type="number" oninput="setRate(event)" min="0" max="65535" step="20" />
      </label>

      <label class="x"> x: <input readonly /> </label>
      <label class="y"> y: <input readonly /> </label>
      <label class="z"> z: <input readonly /> </label>
      <label class="timestamp"> timestamp: <input readonly /> </label>
      <label class="interval"> interval: <input readonly /> </label>
    </div>
    <br />

    <div data-type="rotationRate">
      <b>
        Rotation Rate
      </b>

      <label class="rate">
        rate: <input value="0" type="number" oninput="setRate(event)" min="0" max="65535" step="20" />
      </label>

      <label class="x"> pitch: <input readonly /> </label>
      <label class="y"> yaw: <input readonly /> </label>
      <label class="z"> roll: <input readonly /> </label>
      <label class="timestamp"> timestamp: <input readonly /> </label>
      <label class="interval"> interval: <input readonly /> </label>
    </div>
    <br />

    <div data-type="magnetometer">
      <b>
        Magnetometer
      </b>

      <label class="rate">
        rate: <input value="0" type="number" oninput="setRate(event)" min="0" max="65535" step="20" />
      </label>

      <label class="x"> x: <input readonly /> </label>
      <label class="y"> y: <input readonly /> </label>
      <label class="z"> z: <input readonly /> </label>
      <label class="timestamp"> timestamp: <input readonly /> </label>
      <label class="interval"> interval: <input readonly /> </label>
    </div>
    <br />

    <div data-type="quaternion">
      <b>
        Quaternion
      </b>

      <label class="rate">
        rate: <input value="0" type="number" oninput="setRate(event)" min="0" max="65535" step="20" />
      </label>

      <label class="x"> x: <input readonly /> </label>
      <label class="y"> y: <input readonly /> </label>
      <label class="z"> z: <input readonly /> </label>
      <label class="w"> w: <input readonly /> </label>
      <label class="timestamp"> timestamp: <input readonly /> </label>
      <label class="interval"> interval: <input readonly /> </label>
    </div>
    <br />

    <div data-type="euler">
      <b>
        Euler
      </b>

      <label class="x"> pitch: <input readonly /> </label>
      <label class="y"> yaw: <input readonly /> </label>
      <label class="z"> roll: <input readonly /> </label>
      <label class="timestamp"> timestamp: <input readonly /> </label>
      <label class="interval"> interval: <input readonly /> </label>
    </div>
    <br />
  </body>

  <script>
    const missionDevice = new MissionDevice();

    function connect(event) {
      missionDevice.connect().then(() => {
        event.target.remove();
        missionDevice.getName().then(name => {
          document.querySelector(".name input").value = name;
        });
      });
    }

    function setRate(event) {
      const rate = Number(event.target.value);
      missionDevice.setRate(rate);
    }

    function setRate(event) {
      const dataType = event.target.closest("[data-type]").dataset.type;
      const rate = Number(event.target.value);
      missionDevice.configureImu({ [dataType]: rate });
    }

    function setName(event) {
      const name = document.querySelector(".name input").value;
      event.target.disabled = true;
      missionDevice.setName(name).then(() => {
        event.target.disabled = false;
      });
    }

    missionDevice.addEventListener("calibration", event => {
      for (const type in missionDevice.calibration) {
        document.querySelector(`[data-calibration="${type}"] span`).innerText =
          missionDevice.calibration[type];
      }
      document.querySelector(`[data-calibration="fully"] span`).innerText = missionDevice.isFullyCalibrated? "true":"false";
    });
    
    missionDevice.addEventListener("batterylevel", event => {
      document.querySelector(".batteryLevel span").innerText = missionDevice.batteryLevel
    })

    const timestamps = {};
    missionDevice.dataTypes.forEach(dataType => {
      missionDevice.addEventListener(dataType, event => {
        const { message } = event;
        const { timestamp } = message;

        const components = ["x", "y", "z"];
        if (dataType === "quaternion") {
          components.push("w");
        }

        const container = document.querySelector(`[data-type="${dataType}"]`);
        components.forEach(component => {
          container.querySelector(`.${component} input`).value = message[
            dataType
          ][component];
        });
        container.querySelector(`.timestamp input`).value = timestamp;

        const interval =
          dataType in timestamps ? timestamp - timestamps[dataType] : 0;
        timestamps[dataType] = timestamp;
        container.querySelector(`.interval input`).value = interval;
      });
    });
  </script>
</html>
